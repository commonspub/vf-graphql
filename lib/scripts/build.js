/**
 * Build script for packaging the GraphQL source files as nodejs modules
 *
 * @package: HoloREA
 * @since:   2019-05-22
 * @flow
 */

const fs = require('fs')
const path = require('path')

const {
  graphqlSync,
  introspectionQuery,
  buildASTSchema,
} = require('graphql')
const { mergeTypeDefs } = require('@graphql-toolkit/schema-merging')
const { fromIntrospectionQuery } = require('graphql-2-json-schema')

const SOURCE_FILES = [
  'structs',
  'agent',
  'observation',
  'planning',
  'knowledge',
  'query',
  'mutation',
]

const TEMPLATE = `
// Generated by scripts/build.js - edit the *.gql file instead!

module.exports = \`
$SCHEMA_DOCUMENT
\`

`;

// bundle each schema file as a nodejs module that exports a string
const typeDefs = SOURCE_FILES
  .map(f => {
    const doc = fs.readFileSync(path.resolve(__dirname, `../schemas/${f}.gql`))
    const docString = doc.toString()

    // write JavaScript module version
    fs.writeFileSync(
      path.resolve(__dirname, `../build/${f}.js`),
      TEMPLATE.replace('$SCHEMA_DOCUMENT', docString.replace(/`/g, '\\`'))
    )

    return docString
  })

const schema = buildASTSchema(mergeTypeDefs(typeDefs, { throwOnConflict: true }))


// generate & write JSON Schema version
const introspection = graphqlSync(schema, introspectionQuery)

if (!introspection) {
  throw new Error('Unknown error executing introspection query. Schema may be invalid- does `npm run test` pass?')
} else if (introspection.error) {
  throw introspection.error
}

fs.writeFileSync(
  path.resolve(__dirname, `../json-schema.json`),
  JSON.stringify(fromIntrospectionQuery(introspection.data), undefined, 2)
)

fs.copyFileSync(path.resolve(__dirname, '../../LICENSE'), path.resolve(__dirname, '../LICENSE'))
fs.copyFileSync(path.resolve(__dirname, '../../README.md'), path.resolve(__dirname, '../README.md'))
fs.copyFileSync(path.resolve(__dirname, '../../CHANGELOG.md'), path.resolve(__dirname, '../CHANGELOG.md'))
